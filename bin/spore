#!/usr/bin/env node

var program = require('commander'),
    path = require('path'),
    readline = require('readline-sync'),
    colors = require('colors'),
    spawn = require('child_process').spawn,
    pkg = require('../package.json'),
    resolvePath = require('../lib/utils/resolve_path'),
    Spore = require('../lib/spore'),
    spore = new Spore();

colors.setTheme({
  silly: 'rainbow',
  input: 'grey',
  verbose: 'cyan',
  prompt: 'grey',
  info: 'green',
  data: 'grey',
  help: 'cyan',
  warn: 'yellow',
  debug: 'blue',
  error: 'red'
});

process.title = program._name = "spore";

program
  .version(pkg.version);

program
  .command('signup')
  .option("-e, --email <email>", "Email to sign up with")
  .option("-p, --password <password>", "Password to sign up with")
  .description("Create an Spore account")
  .action(function (options) {

    var email = options.email || readline.question("Email: ".prompt),
        password = options.password || readline.question("Password: ".prompt, { hideEchoBack: true });

    if(!email || !password) return error(new Error("Email and password are required."));

    spore.signup(email, password, function (err, user) {
      if(err) return error(err);

      info("Account created for " + user.email + ".");
    });
  });

program
  .command('login')
  .option("-e, --email <email>", "Email to log in with")
  .option("-p, --password <password>", "Password to log in with")
  .description("Log in to your Spore account")
  .action(function (options) {

    login(options.email, options.password, function (_, user) {
      info("Logged in as " + user.email + ".");
    });
  });

program
  .command('apps')
  .description("List all the apps you have access to")
  .action(function () {
    ensureLogin(function () {
      spore.api.listApps(function (err, apps) {
        if(err) return error(err);

        if(apps.length) {
          info(apps.join("\n"));
        } else {
          warn("No Apps found.");
          help("Create a new app with `spore new`.");
        }
      });
    });
  });

program
  .command('new [dir]')
  .alias('init [dir]')
  .option('-a, --app <appName>', "Name of the application")
  .description("Create a new Spore App")
  .action(function (dir, options) {
    var appName = options.appName;
    dir = resolvePath(process.cwd(), dir || ".");

    spore.createApp(dir, appName, function (err, app) {
      if(err) return error(err);

      info(app.name + " created.");
    });
  });

program
  .command('set [key]')
  .option('-d, --directory <directory>', "Directory in which contains the Spore")
  .option('-e, --env <envName>', "Name of the environment")
  .description("Set an environment variable for a Spore app")
  .action(function (key, options) {

    spore.loadApp(resolvePath(process.cwd(), options.directory || '.'), function (err, app) {
      if(err) return error(err);

      spore.defaultEnv(function (err, envName) {
        if(err) return error(err);

        envName = options.envName || envName;

        var value = readline.question(key + "=".prompt);

        app.set(envName, key, value, function (err) {
          if(err) return error(err);

          info(key + " set for " + app.name + "/" + envName);
        });
      });
    });
  });

program
  .command('run [commands...]')
  .alias('exec [commands...]')
  .option('-d, --directory <directory>', "Directory in which contains the Spore")
  .option('-e, --env <envName>', "Name of the environment")
  .description("Run a command with Spore environment variables loaded")
  .action(function (cmds, options) {
    spore.loadApp(resolvePath(process.cwd(), options.directory || '.'), function (err, app) {
      if(err) return error(err);

      spore.defaultEnv(function (err, envName) {
        if(err) return error(err);

        app.run(cmds, options.envName || envName, function (err, child) {
          if(err) return error(err);

          child.stdout.on('data', function (data) {
            process.stdout.write(data);
          });

          child.stderr.on('data', function (data) {
            process.stderr.write(data);
          });

          child.on('error', function (err) {
            error(err);
          });

          child.on('close', function (code) {
            if(code === 0) {
              info(cmd + " exited with code " + code);
            } else {
              error(new Error(cmd + " exited with code " + code));
            }
            process.exit(0);
          });
        });
      });
    });
  });

function ensureLogin(callback) {
  if(spore.getKey()) {
    return callback(null, true);
  }

  login(null, null, callback);
}

function login(email, password, callback) {
  email = email || readline.question("Email: ".prompt);
  password = password || readline.question("Password: ".prompt, { hideEchoBack: true });

  if(!email || !password) return error(new Error("Email and password are required."));

  spore.login(email, password, function (err, user) {
    if(err) error(err);

    callback(null, user);
  });
}

function error(err) {
  console.error(err.message.error);
}

function info(message) {
  console.info(message.info);
}

function help(message) {
  console.log(message.help);
}

function warn(message) {
  console.warn(message.warn);
}

if (!process.argv.slice(2).length) {
  program.help();
}

program.parse(process.argv);
